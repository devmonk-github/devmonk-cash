<div class="card shadow-sm">
    <div class="card-header" style="margin-top: 20px;">
        <h4>{{ 'ACTIVITY_DETAILS' | translate}}</h4>
        <div mat-dialog-actions>
            <button mat-dialog-close type="button" class="btn btn-sm btn-light" (click)="close(false)">
                <fa-icon [icon]="faTimes"></fa-icon>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-3">
                <h3>{{activity.sNumber}}</h3>
                <div class="d-flex flex-wrap py-5 border">
                    <div class="flex-equal me-5">
                        Customer Details
                        <div class="fs-6 ms-1">
                            <div class="align-items-center">
                                <div class="text-gray-600">{{customer?.sFirstName || ''}} {{customer?.sLastName || ''}}
                                </div>
                            </div>
                        </div>
                        <div class="fs-6 ms-1">
                            <div class="align-items-center">
                                <div class="text-gray-600">{{customer?.sEmail || ''}}<a
                                        href="mailto:{{customer?.sEmail}}">
                                        <fa-icon [icon]="faEnvelope"></fa-icon>
                                    </a></div>
                            </div>
                        </div>
                        <div class="fs-6 ms-1">
                            <div class="align-items-center">
                                {{'PHONE_MOBILE' | translate}}
                                <span>{{customer?.oPhone?.sMobile}}
                                    <i class="fab fa-whatsapp ms-1" *ngIf="customer?.oPhone?.bWhatsApp"
                                        style="color: #1CB39B;"></i>
                                </span>
                            </div>
                        </div>
                        <div class="fs-6 ms-1">
                            <div class="align-items-center">
                                {{'PHONE_LANDLINE' | translate}}
                                <span>{{customer?.oPhone?.sLandLine}}
                                </span>
                            </div>
                        </div>

                        <div class="fs-6 ms-1">
                            <div class="align-items-center">
                                {{'Advised by' | translate}}
                                <span>{{customer?.oPhone?.sLandLine}}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-9">
                <h4>Activities</h4>
                <div class="accordion" id="kt_accordion_1">
                    <div class="accordion-item" *ngFor="let activity of activityItems; index as index">
                        <h2 class="accordion-header">
                            <button class="accordion-button fs-4 fw-bold collapsed" type="button"
                                data-bs-toggle="collapse" #accordionBtn>
                                <label>{{activity.sNumber}}</label>
                            </button>
                        </h2>
                        <div class="accordion-collapse collapse" data-bs-parent="accordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-4">
                                        <span>Title</span>
                                        <label for="description" for="activityName">{{ "NAME" | translate}}</label>
                                        <input type="text" name="activityName" [(ngModel)]="activity.sProductName"
                                            class="form-control">
                                        <label for="description">{{ "DESCRIPTION" | translate}}</label>
                                        <textarea class="form-control" name="description"
                                            placeholder="{{ 'DESCRIPTION' | translate}}" lines="10"
                                            [(ngModel)]="activity.sDescription"></textarea>
                                    </div>
                                    <div class="col-5">

                                        <!-- <div class="progress-track">
                                            <ul id="progressbar">
                                                <li class="step0 active " id="step1">Info</li>
                                                <li class="step0 active text-center" id="step2">Processing</li>
                                                <li class="step0 active text-center" id="step3">Cancelled</li>
                                                <li class="step0 active text-right" id="step4">Inspection</li>
                                                <li class="step0 text-right" id="step5">Completed</li>
                                            </ul>
                                        </div> -->

                                        <label for="status" for="activityName">{{ "STATUS" | translate}}</label>

                                        <select name="status" id="status" class="form-select"
                                            [(ngModel)]="activity.eRepairStatus">
                                            <option *ngFor="let type of repairStatus" [value]="type">{{type}}</option>
                                        </select>
                                        <div>
                                            Inform the customer that the product can be picked up.
                                        </div>
                                        <div class="border">
                                            <div class="border">
                                                To be paid (excl. deposits/refunds/gold purchase/other fees)
                                            </div>
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="form-control w-100" type="text"
                                                        [(ngModel)]="activity.nTotalAmount">
                                                </div>
                                                <div class="col-4">
                                                    <button class="btn btn-primary">Mail customer</button>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    Already paid: {{activity.nPaidAmount | currency: '€'}}
                                                </div>
                                                <div class="col-6">
                                                    Still to pay: {{(activity.nTotalAmount - activity.nPaidAmount) |
                                                    currency:
                                                    '€'}}
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                The advance payment could be spread over several products. Click on the
                                                receipt
                                                to see the total amount of the transaction, so you know for which item
                                                is
                                                paid.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="btn-group me-4 w-100">
                                            <span class="btn btn-primary fs-bold px-6"
                                                (click)="downloadCustomerReceipt(index)">
                                                <fa-icon [icon]="faUser"></fa-icon>
                                                <span class="indicator-label">{{ "CUSTOMER_RECEIPT"}}</span>
                                            </span>
                                            <span class="btn btn-primary btn-icon fs-bold" role="button">
                                                <div class="btn btn-icon" data-kt-menu-trigger="click"
                                                    data-kt-menu-attach="parent" data-kt-menu-placement="bottom-start"
                                                    data-kt-menu-flip="bottom">
                                                    <span class="svg-icon svg-icon-2 m-0">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                            viewBox="0 0 24 24" fill="none">
                                                            <path
                                                                d="M11.4343 12.7344L7.25 8.55005C6.83579 8.13583 6.16421 8.13584 5.75 8.55005C5.33579 8.96426 5.33579 9.63583 5.75 10.05L11.2929 15.5929C11.6834 15.9835 12.3166 15.9835 12.7071 15.5929L18.25 10.05C18.6642 9.63584 18.6642 8.96426 18.25 8.55005C17.8358 8.13584 17.1642 8.13584 16.75 8.55005L12.5657 12.7344C12.2533 13.0468 11.7467 13.0468 11.4343 12.7344Z"
                                                                fill="black"></path>
                                                        </svg>
                                                    </span>
                                                </div>
                                                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-bold fs-7 w-200px py-4"
                                                    data-kt-menu="true">
                                                    <div class="menu-item px-3 text-center">
                                                        <div class="menu-link px-3">tMenu</div>
                                                    </div>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="btn-group me-4 w-100">
                                            <span class="btn btn-primary fs-bold px-6">
                                                <fa-icon [icon]="faReceipt"></fa-icon>
                                                <span class="indicator-label">{{ "RECEIPT_PARTNER"}}</span>
                                            </span>
                                            <span class="btn btn-primary btn-icon fs-bold" role="button">
                                                <div class="btn btn-icon" data-kt-menu-trigger="click"
                                                    data-kt-menu-attach="parent" data-kt-menu-placement="bottom-start"
                                                    data-kt-menu-flip="bottom">
                                                    <span class="svg-icon svg-icon-2 m-0">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                            viewBox="0 0 24 24" fill="none">
                                                            <path
                                                                d="M11.4343 12.7344L7.25 8.55005C6.83579 8.13583 6.16421 8.13584 5.75 8.55005C5.33579 8.96426 5.33579 9.63583 5.75 10.05L11.2929 15.5929C11.6834 15.9835 12.3166 15.9835 12.7071 15.5929L18.25 10.05C18.6642 9.63584 18.6642 8.96426 18.25 8.55005C17.8358 8.13584 17.1642 8.13584 16.75 8.55005L12.5657 12.7344C12.2533 13.0468 11.7467 13.0468 11.4343 12.7344Z"
                                                                fill="black"></path>
                                                        </svg>
                                                    </span>
                                                </div>
                                                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-bold fs-7 w-200px py-4"
                                                    data-kt-menu="true">
                                                    <div class="menu-item px-3 text-center">
                                                        <div class="menu-link px-3">tMenu</div>
                                                    </div>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="btn-group me-4 w-100">
                                            <span class="btn btn-primary fs-bold px-6">
                                                <span>
                                                    <fa-icon [icon]="faReceipt"></fa-icon>
                                                </span>
                                                <span class="indicator-label">{{ "RECEIPT_FOR_BOTH"}}</span>
                                            </span>
                                            <span class="btn btn-primary btn-icon fs-bold" role="button">
                                                <div class="btn btn-icon" data-kt-menu-trigger="click"
                                                    data-kt-menu-attach="parent" data-kt-menu-placement="bottom-start"
                                                    data-kt-menu-flip="bottom">
                                                    <span class="svg-icon svg-icon-2 m-0">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                            viewBox="0 0 24 24" fill="none">
                                                            <path
                                                                d="M11.4343 12.7344L7.25 8.55005C6.83579 8.13583 6.16421 8.13584 5.75 8.55005C5.33579 8.96426 5.33579 9.63583 5.75 10.05L11.2929 15.5929C11.6834 15.9835 12.3166 15.9835 12.7071 15.5929L18.25 10.05C18.6642 9.63584 18.6642 8.96426 18.25 8.55005C17.8358 8.13584 17.1642 8.13584 16.75 8.55005L12.5657 12.7344C12.2533 13.0468 11.7467 13.0468 11.4343 12.7344Z"
                                                                fill="black"></path>
                                                        </svg>
                                                    </span>
                                                </div>
                                                <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-bold fs-7 w-200px py-4"
                                                    data-kt-menu="true">
                                                    <div class="menu-item px-3 text-center">
                                                        <div class="menu-link px-3">tMenu</div>
                                                    </div>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="btn-group me-4 w-100">
                                            <span class="btn btn-primary fs-bold px-6">
                                                <fa-icon [icon]="faEnvelope"></fa-icon>
                                                <span class="indicator-label">{{ "MAIL"}}</span>
                                            </span>
                                        </div>
                                        <div class="btn-group me-4 w-100">
                                            <span class="btn btn-primary fs-bold px-6">
                                                <fa-icon [icon]="faEuro"></fa-icon>
                                                <span class="indicator-label">{{ "CHECKOUT"}}</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="activity.eRepairStatus === 'completed'"
                                    class="col-md-12 card-body d-flex flex-wrap py-5 border mt-5 mb-5 row">
                                    <div class="col-md-8">
                                        <div class="">
                                            <span>{{ "SHIPPING_METHOD" | translate }} : </span>
                                            <label class="form-control-solid">Standard Shipping</label>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label>{{ "CARRIER" | translate}}</label>
                                            </div>
                                            <div class="col-md-6">
                                                <select name="career" id="career" class="form-select">
                                                    <option>PostNL</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <input type="text" class="form-control"
                                                placeholder="www.trackandtracelink.com">
                                        </div>
                                        <div class="row">
                                            <label>Only place the tracking code here</label>
                                        </div>
                                        <div class="row">
                                            <label>Open tracking link</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 gap-5">
                                        <button class="btn btn-primary w-100 d-flex">
                                            <label class="mx-auto">Sent to customer</label>
                                        </button>
                                        <button class="btn btn-secondary w-100 d-flex">
                                            <label class="mx-auto">Ready to pik up</label>
                                        </button>
                                        <button class="btn btn-secondary w-100 d-flex">
                                            <label class="mx-auto">Deliver</label>
                                        </button>
                                        <button *ngIf="webOrders" class="btn btn-primary w-100 d-flex"
                                            (click)="openTransaction(activity, 'activity')">
                                            <label class="mx-auto">Open activity</label>
                                        </button>
                                    </div>
                                </div>
                                <div class="row">
                                    <input type="text" name="activityName" [(ngModel)]="activity.sProductName"
                                        class="form-control">
                                    <div class="col-5">
                                        <div class="row">
                                            <div class="col-6">
                                                Intake date
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.dCreatedDate">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Location
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.iLocationId">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Estimated date ready
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.dEstimatedDate">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Contact when ready
                                            </div>
                                            <div class="col-6">
                                                Intake date
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Estimated price upon ingestion
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.nPriceIncVat">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                To be paid (excl. deposits/refunds/gold purchse/other fees)
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.nPriceIncVat">
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table
                                                class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer">
                                                <thead>
                                                    <tr
                                                        class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                                        <th>
                                                            Receipt number
                                                        </th>
                                                        <th>
                                                            Created Date
                                                        </th>
                                                        <th>
                                                            Amount
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody class="fw-bold text-gray-600">
                                                    <tr *ngFor='let receipt of activity.receipts'>
                                                        <td>{{receipt.sTransactionNumber}}</td>
                                                        <td>{{receipt.dCreatedDate | date: 'medium'}}</td>
                                                        <td>{{receipt.nPaymentAmount | currency: '€'}}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div *ngIf="!activity?.aImage?.length">
                                            No Images
                                        </div>
                                        <div class="d-flex">
                                            <div class="image-input p-1"
                                                *ngFor="let image of activity.aImage; let i = index"
                                                data-kt-image-input="true"
                                                style="background-image: url('assets/media/svg/avatars/blank.svg')">
                                                <div class="image-input-wrapper w-100px h-100px"
                                                    style="background-image: url(assets/media/avatars/300-1.jpg)">
                                                    <img src={{image}} width="100px" height="100px">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="row">
                                            <div class="col-6">
                                                Brand
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control" [(ngModel)]="activity.iBrandId">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Repair number
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.sBagNumber">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Costs incurred (excluding VAT)
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.nPriceIncVat">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Product category
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.iArticleGroupId">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Product material
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.iArticleGroupId">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                Supplier
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control"
                                                    [(ngModel)]="activity.iSupplierId">
                                            </div>
                                        </div>
                                        <div>
                                            I repair this myself
                                        </div>
                                        <div>
                                            Repairer
                                            <input type="text" class="form-control" placeholder="Search employee">
                                            OR
                                            <input type="text" class="form-control" placeholder="Search repairer">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6">
                                        <label for="sCommentVisibleServicePartner">{{ "REMARK_FOR_SERVICE_PARTNERS" |
                                            translate}}</label>
                                        <textarea class="form-control" name="sCommentVisibleServicePartner"
                                            placeholder="{{ 'REMARK_FOR_SERVICE_PARTNERS' | translate}}" lines="10"
                                            [(ngModel)]="activity.sCommentVisibleServicePartner"></textarea>
                                    </div>
                                    <div class="col-6">
                                        <label for="sCommentVisibleCollegues">{{ "REMARK_FOR_COLLEAGUES" |
                                            translate}}</label>
                                        <textarea class="form-control" name="sCommentVisibleCollegues"
                                            placeholder="{{ 'REMARK_FOR_COLLEAGUES' | translate}}" lines="10"
                                            [(ngModel)]="activity.sCommentVisibleCollegues"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="card-body row">
        <div class="col-md-12">
            <h3 class="fw-bolder mb-3">
                <span>{{ "ITEMS" | translate }}</span>
            </h3>
            <div class="row">
                <div class="col-md-2">
                    <span>{{ "STATUS" | translate }} : </span>
                </div>
                <div class="col-md-4">
                    <select name="status" id="status" class="form-select" [(ngModel)]="activity.eRepairStatus">
                        <option *ngFor="let type of repairStatus" [value]="type">{{type}}</option>
                    </select>
                </div>
            </div>
            <div class="row fw-bold gy-1 d-flex flex-wrap py-5">
                <div class="flex-equal me-5">
                    <table class="table table-hover table-rounded table-striped border gy-7 gs-7">
                        <thead>
                            <tr class="fw-bold fs-6 text-gray-400">
                                <td class="text-muted">{{'IMAGE' | translate}}</td>
                                <td class="text-muted">{{'PRODUCT' | translate}}</td>
                                <td class="text-muted">{{'PRICE' | translate}}</td>
                                <td class="text-muted">{{'QUANTITY' | translate}}</td>
                                <td class="text-muted">{{'DISCOUNT_PER_ITEM' | translate}}</td>
                                <td class="text-muted">{{'TAX' | translate}}</td>
                                <td class="text-muted">{{'TOTAL_PRICE' | translate}}</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of transactions; let i = index">
                                <td>
                                    <img src="{{ item?.aImage?.length > 0 ? item.aImage[0] : imagePlaceHolder}}"
                                        (error)="item.aImage[0]=imagePlaceHolder" class="product_image">
                                </td>
                                <td>
                                    <div>
                                        {{item.sProductName}}
                                    </div>
                                    <br>
                                    <div *ngIf="item?.aProductVariant?.length > 0">
                                        <div *ngFor="let variant of item.aProductVariant" class="d-flex">
                                            <div class="w-25">
                                                {{ variant.sVariantBase }}
                                            </div> :
                                            <div class="w-50 px-2">
                                                <span *ngIf="variant.sVariantBase !== 'color'"> {{ variant.value }}
                                                </span>
                                                <span *ngIf="variant.sVariantBase === 'color'"
                                                    [style.background]="variant.value"
                                                    class="px-2 border border-gray-600"></span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{item.nPurchasePrice}}</td>
                                <td>{{item.nQuantity}}</td>
                                <td>0</td>
                                <td>{{item.nVatRate || 0}}</td>
                                <td>{{item.nPriceIncVat || 0}}</td>
                                <td>
                                    <div class="d-flex align-items-stretch flex-shrink-0 me-sm-2"
                                        *ngIf="showDetails && userDetail">
                                        <div class="cursor-pointer my-auto fs-5 fw-bolder text-gray-700 show menu-dropdown"
                                            data-kt-menu-trigger="click" data-kt-menu-attach="parent"
                                            data-kt-menu-placement="bottom-start" data-kt-menu-flip="bottom">
                                            <label class="fs-5 form-label fw-bolder text-dark">Location : </label>
                                            <span *ngIf="item">( {{item.locationName || 'Unknown'}} )</span>
                                        </div>
                                        <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg menu-state-primary fw-bold py-4 fs-6 w-200px" data-kt-menu="true">
                                            <span *ngFor="let business of userDetail.aBusiness">
                                                <div *ngIf="business?.aInLocation?.length > 0" class="menu-item px-3"
                                                    data-kt-menu-trigger="hover" data-kt-menu-placement="right-start">
                                                    <span class="menu-link d-flex">
                                                        <div> {{ business.sName || 'Unknown' }} </div>
                                                        <fa-icon [icon]="faChevronRight" class="ms-auto me-2"></fa-icon>
                                                    </span>
                                                    <div class="menu-sub menu-sub-dropdown py-4">
                                                        <div class="menu-item px-3 cursor-pointer"
                                                            *ngFor="let location of business.aInLocation">
                                                            <a class="menu-link d-flex px-5"
                                                                (click)="selectBusiness(business, i, location)">
                                                                {{ location.sName }}
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div *ngIf="business?.aInLocation?.length == 0" class="menu-item px-3">
                                                    <span class="menu-link d-flex" (click)="selectBusiness(business, i)">
                                                        {{ business.sName || 'Unknown'}}</span>
                                                </div>
                                            </span>
                                        </div>
                                        <span class="h-20px border-gray-300 border-start mx-4 my-auto"></span>
                                    </div>
                                </td>
                            </tr>
                            <tr *ngIf='transactions.length'>
                                <td>{{'TOTAL' | translate}}</td>
                                <td></td>
                                <td></td>
                                <td>{{quantity}}</td>
                                <td></td>
                                <td></td>
                                <td>{{totalPrice}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="d-flex">
                <h5 *ngIf='!transactions.length && !loading' style="text-align: center">{{'NO_DATA_FOUND' | translate }}
                </h5>
                <div *ngIf="loading" class="spinner-border mx-auto"></div>
            </div>
        </div>
    </div>
    <div class="card-footer">
        <button class="btn btn-primary" (click)="submit()" type="submit">Submit</button>
    </div>
</div>
